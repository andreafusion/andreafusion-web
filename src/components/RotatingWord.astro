---
// src/components/RotatingWord.astro
---

<span class="rw-wrapper" aria-live="polite" aria-atomic="true">
  <span class="rw-text" id="rotating-word"></span><span class="rw-cursor" aria-hidden="true">|</span>
</span>

<script>
  const WORDS = [
    'lo pille',
    'te recuerde',
    'se divierta',
    'confíe',
    'te escriba',
    'reserve',
    'compre',
  ];

  const TYPE_MS   = 80;   // ms por carácter al escribir
  const DELETE_MS = 45;   // ms por carácter al borrar (más rápido)
  const PAUSE_MS  = 1800; // ms que permanece la palabra completa
  const START_MS  = 900;  // pausa antes de empezar a escribir la primera

  const el = document.getElementById('rotating-word') as HTMLElement;
  if (!el) throw new Error('rotating-word not found');

  if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
    el.textContent = WORDS[0] ?? '';
  } else {
    let wordIndex = 0;
    let charIndex = 0;
    type State = 'typing' | 'pausing' | 'deleting' | 'waiting';
    let state: State = 'waiting';

    const tick = () => {
      const word = WORDS[wordIndex] ?? '';

      if (state === 'waiting') {
        // Pausa inicial antes de escribir la primera palabra
        state = 'typing';
        setTimeout(tick, START_MS);
        return;
      }

      if (state === 'typing') {
        charIndex++;
        el.textContent = word.slice(0, charIndex);

        if (charIndex < word.length) {
          // Pequeña variación aleatoria ±20ms para que no parezca robótico
          setTimeout(tick, TYPE_MS + (Math.random() * 40 - 20));
        } else {
          // Palabra completa — pausa antes de borrar
          state = 'pausing';
          setTimeout(tick, PAUSE_MS);
        }
        return;
      }

      if (state === 'pausing') {
        state = 'deleting';
        tick();
        return;
      }

      if (state === 'deleting') {
        charIndex--;
        el.textContent = word.slice(0, charIndex);

        if (charIndex > 0) {
          setTimeout(tick, DELETE_MS + (Math.random() * 20 - 10));
        } else {
          // Borrado completo — siguiente palabra
          wordIndex = (wordIndex + 1) % WORDS.length;
          state = 'typing';
          setTimeout(tick, 180); // pequeña pausa entre palabras
        }
        return;
      }
    };

    tick();
  }
</script>

<style>
  .rw-wrapper {
    display: inline-flex;
    align-items: baseline;
    gap: 0;
    height: 1.1em;
    min-width: 14ch;
    vertical-align: bottom;
    position: relative;
    /* Sin overflow:hidden para que el cursor no se corte */
  }

  .rw-text {
    display: inline;
    font-size: inherit;
    line-height: inherit;
    font-family: var(--font-script);
    font-style: italic;
    font-weight: 600;
    color: var(--color-accent-lime);
    white-space: nowrap;
  }

  /* Cursor parpadeante */
  .rw-cursor {
    display: inline-block;
    font-family: var(--font-body);
    font-style: normal;
    font-weight: 300;
    font-size: 0.85em;
    color: var(--color-accent-lime);
    opacity: 1;
    margin-left: 2px;
    animation: blink 0.9s step-end infinite;
  }

  @keyframes blink {
    0%, 100% { opacity: 1; }
    50%       { opacity: 0; }
  }

  @media (prefers-reduced-motion: reduce) {
    .rw-cursor { animation: none; opacity: 1; }
  }
</style>