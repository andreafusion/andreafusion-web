---
// src/components/CursorEffect.astro
// Mini cursor retro que aparece SOLO al pasar por h1/h2/h3.
// No es un cursor global loco. Es un guiño editorial puntual.
// No hace nada en móvil (pointer:coarse).
---

<!-- El cursor es un div absolutamente posicionado, controlado por JS -->
<div class="retro-cursor" id="retro-cursor" aria-hidden="true">
  <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
    <!-- Cursor retro pixelado estilo años 90 -->
    <rect x="0" y="0" width="3" height="3" fill="currentColor"/>
    <rect x="0" y="3" width="3" height="3" fill="currentColor"/>
    <rect x="3" y="3" width="3" height="3" fill="currentColor"/>
    <rect x="0" y="6" width="3" height="3" fill="currentColor"/>
    <rect x="3" y="6" width="3" height="3" fill="currentColor"/>
    <rect x="6" y="6" width="3" height="3" fill="currentColor"/>
    <rect x="0" y="9" width="3" height="3" fill="currentColor"/>
    <rect x="3" y="9" width="3" height="3" fill="currentColor"/>
    <rect x="6" y="9" width="3" height="3" fill="currentColor"/>
    <rect x="9" y="9" width="3" height="3" fill="currentColor"/>
    <rect x="3" y="12" width="3" height="3" fill="currentColor"/>
    <rect x="9" y="12" width="3" height="3" fill="currentColor"/>
    <rect x="6" y="15" width="3" height="3" fill="currentColor"/>
    <rect x="12" y="15" width="3" height="3" fill="currentColor"/>
  </svg>
</div>

<script>
  // Solo en dispositivos con pointer fino (mouse/trackpad)
  const isCoarsePointer = window.matchMedia('(pointer: coarse)').matches;
  const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

  if (isCoarsePointer || prefersReducedMotion) {
    // En móvil o reduced-motion: no hacer nada
    const el = document.getElementById('retro-cursor');
    if (el) el.remove();
  } else {
    const cursor = document.getElementById('retro-cursor') as HTMLElement | null;
    if (!cursor) throw new Error('[CursorEffect] elemento no encontrado');

    let mouseX = 0;
    let mouseY = 0;
    let hideTimeout: ReturnType<typeof setTimeout>;
    let isOverHeading = false;

    // Mover el cursor al ratón
    document.addEventListener('mousemove', (e: MouseEvent) => {
      mouseX = e.clientX;
      mouseY = e.clientY;

      if (isOverHeading) {
        cursor.style.left = `${mouseX + 14}px`;
        cursor.style.top  = `${mouseY + 8}px`;
      }
    }, { passive: true });

    // Detectar hover en titulares
    const headings = document.querySelectorAll<HTMLElement>('h1, h2, h3');

    headings.forEach(h => {
      h.addEventListener('mouseenter', () => {
        isOverHeading = true;
        clearTimeout(hideTimeout);

        cursor.style.left = `${mouseX + 14}px`;
        cursor.style.top  = `${mouseY + 8}px`;
        cursor.classList.add('is-visible');
      });

      h.addEventListener('mouseleave', () => {
        isOverHeading = false;
        // Desaparece suavemente en 0.5s
        hideTimeout = setTimeout(() => {
          cursor.classList.remove('is-visible');
        }, 500);
      });
    });
  }
</script>

<style>
  .retro-cursor {
    /*
      Fijo en viewport, encima de todo.
      Solo visible cuando .is-visible está activo.
    */
    position: fixed;
    top: 0;
    left: 0;
    z-index: 9999;
    pointer-events: none;
    color: var(--color-accent-lime);

    /* Estado inicial: invisible */
    opacity: 0;
    transform: scale(0.6) rotate(-10deg);
    transition:
      opacity 0.2s ease,
      transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);

    /* No interfiere con el cursor nativo */
    user-select: none;
  }

  .retro-cursor.is-visible {
    opacity: 1;
    transform: scale(1) rotate(0deg);
  }

  /* Ocultamos el cursor nativo SOLO sobre titulares */
  :global(h1:hover),
  :global(h2:hover),
  :global(h3:hover) {
    cursor: none;
  }

  /* En móvil: nunca mostramos el cursor custom */
  @media (pointer: coarse) {
    .retro-cursor { display: none; }
  }
</style>