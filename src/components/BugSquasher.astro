---
// src/components/BugSquasher.astro
// Bug pixelado escondido en portfolio. Click → squash animado.
// Aparece 3s después de cargar. Solo una vez por sesión.
---

<div class="bug-wrap" id="bug-squasher" role="button" tabindex="0" aria-label="Elimina el bug">

  <!-- Bug vivo -->
  <div class="bug" id="bug-body">
    <svg class="bug__svg" width="28" height="28" viewBox="0 0 28 28" fill="none" aria-hidden="true">
      <rect x="10" y="8"  width="8" height="12" fill="#c8f135"/>
      <rect x="11" y="5"  width="6" height="4"  fill="#c8f135"/>
      <rect x="11" y="6"  width="2" height="2"  fill="#1a0a2e"/>
      <rect x="15" y="6"  width="2" height="2"  fill="#1a0a2e"/>
      <rect x="10" y="3"  width="2" height="3"  fill="#c8f135"/>
      <rect x="16" y="3"  width="2" height="3"  fill="#c8f135"/>
      <rect x="8"  y="2"  width="2" height="2"  fill="#c8f135"/>
      <rect x="18" y="2"  width="2" height="2"  fill="#c8f135"/>
      <rect x="6"  y="10" width="4" height="2"  fill="#c8f135"/>
      <rect x="6"  y="14" width="4" height="2"  fill="#c8f135"/>
      <rect x="6"  y="18" width="4" height="2"  fill="#c8f135"/>
      <rect x="18" y="10" width="4" height="2"  fill="#c8f135"/>
      <rect x="18" y="14" width="4" height="2"  fill="#c8f135"/>
      <rect x="18" y="18" width="4" height="2"  fill="#c8f135"/>
      <rect x="11" y="20" width="6" height="4"  fill="#c8f135"/>
    </svg>
  </div>

  <!-- Bug aplastado (oculto hasta el squash) -->
  <div class="bug__squashed" id="bug-squashed" aria-hidden="true">
    <svg width="32" height="10" viewBox="0 0 32 10" fill="none">
      <ellipse cx="16" cy="5" rx="14" ry="3.5" fill="rgba(200,241,53,0.75)"/>
      <rect x="3"  y="2" width="2" height="2" fill="#c8f135"/>
      <rect x="27" y="2" width="2" height="2" fill="#c8f135"/>
      <rect x="1"  y="5" width="2" height="2" fill="#c8f135"/>
      <rect x="29" y="5" width="2" height="2" fill="#c8f135"/>
    </svg>
    <span class="bug__msg">✓ Bug eliminado</span>
  </div>

</div>

<script>
  // Usamos window.addEventListener('load') para asegurarnos de que
  // el DOM está completamente listo antes de buscar los elementos.
  window.addEventListener('load', () => {
    const STORAGE_KEY = 'af_bug_squashed';

    const wrap     = document.getElementById('bug-squasher');
    const body     = document.getElementById('bug-body');
    const squashed = document.getElementById('bug-squashed');

    // Salida silenciosa si falta algún elemento (no throws)
    if (!wrap || !body || !squashed) return;

    // Si ya fue aplastado esta sesión: ocultar sin ruido
    if (sessionStorage.getItem(STORAGE_KEY)) {
      wrap.style.display = 'none';
      return;
    }

    let isDead = false;

    // ── Aparecer a los 3s ──
    setTimeout(() => {
      if (isDead) return;
      wrap.classList.add('is-visible');

      // Wiggle aleatorio cada 5-9s
      const wiggle = () => {
        if (isDead) return;
        body.classList.add('is-wiggling');
        setTimeout(() => body.classList.remove('is-wiggling'), 600);
        setTimeout(wiggle, 5000 + Math.random() * 4000);
      };
      setTimeout(wiggle, 2000);
    }, 3000);

    // ── Squash ──
    const squash = () => {
      if (isDead) return;
      isDead = true;
      sessionStorage.setItem(STORAGE_KEY, '1');

      // Aplastar
      body.style.transition = 'transform 0.15s ease, opacity 0.15s ease';
      body.style.transform  = 'scaleY(0.1) scaleX(1.5)';
      body.style.opacity    = '0';

      setTimeout(() => {
        body.style.display = 'none';
        squashed.classList.add('is-visible');
      }, 150);

      // Desaparecer tras 2.5s
      setTimeout(() => {
        wrap.style.transition = 'opacity 0.4s ease, transform 0.4s ease';
        wrap.style.opacity    = '0';
        wrap.style.transform  = 'scale(0.7)';
        setTimeout(() => { wrap.style.display = 'none'; }, 400);
      }, 2500);
    };

    wrap.addEventListener('click', squash);
    wrap.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); squash(); }
    });
  });
</script>

<style>
  /* Posicionado en la esquina inferior derecha de su ancestro position:relative */
  .bug-wrap {
    position: absolute;
    bottom: 2rem;
    right: 1.5rem;
    z-index: 50;
    cursor: crosshair;
    /* Invisible hasta .is-visible */
    opacity: 0;
    transform: translateY(6px);
    transition: opacity 0.4s ease, transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  .bug-wrap.is-visible {
    opacity: 1;
    transform: translateY(0);
  }

  /* SVG pixelado */
  .bug__svg {
    display: block;
    image-rendering: pixelated;
    transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1), filter 0.2s ease;
  }

  .bug-wrap:hover .bug__svg {
    transform: scale(1.25) rotate(-10deg);
    filter: drop-shadow(0 0 8px rgba(200, 241, 53, 0.9));
  }

  /* Wiggle */
  .bug.is-wiggling .bug__svg {
    animation: bugWiggle 0.55s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  @keyframes bugWiggle {
    0%   { transform: rotate(0deg)   translateX(0); }
    25%  { transform: rotate(-14deg) translateX(-3px); }
    50%  { transform: rotate(14deg)  translateX(3px); }
    75%  { transform: rotate(-6deg)  translateX(-1px); }
    100% { transform: rotate(0deg)   translateX(0); }
  }

  /* Estado aplastado */
  .bug__squashed {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.3rem;
    opacity: 0;
    transform: scale(0.8);
    transition: opacity 0.2s ease, transform 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  .bug__squashed.is-visible {
    opacity: 1;
    transform: scale(1);
  }

  .bug__msg {
    font-family: var(--font-body);
    font-size: 0.6rem;
    font-weight: 700;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--color-accent-lime);
    white-space: nowrap;
  }

  @media (prefers-reduced-motion: reduce) {
    .bug-wrap     { transition: opacity 0.1s; }
    .bug.is-wiggling .bug__svg { animation: none; }
  }
</style>